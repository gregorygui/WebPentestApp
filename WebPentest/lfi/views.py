import base64
from django.shortcuts import render
from django.http import HttpResponse
from django.views import generic
from django.utils import timezone
from django.shortcuts import redirect
from .models import NameAttack, DetailedAttack
from .forms import FormDetailedAttack, FormNameAttack, FormLaunchAttack, FormB64

def index(request):
	return render(request, 'lfi/index.html', {'attack':NameAttack.objects.all()})

def attack(request, sname):
	at=NameAttack.objects.get(surname=sname)
	det=at.detailedattack_set.all()
	return render(request, 'lfi/attack.html', {
		'attack':NameAttack.objects.all(),
		'at':at,
		'det':det
		})

def b64Module(request):
	if request.method=="POST":
		form=FormB64(request.POST)
		if form.is_valid():
			if request.POST.get('choice'):
				form=FormB64(initial={
					'encode':request.POST.get('encode'),
					'decode':base64.b64encode(bytes(request.POST.get('encode'),"utf-8")),
					'choice':True
					})
				return render(request, 'lfi/form_B64.html', {'attack':NameAttack.objects.all(),'form':form})
			else:
				form=FormB64(initial={
					'encode':base64.b64decode(request.POST.get('decode')).decode("utf-8"),
					'decode':request.POST.get('decode'),
					'choice':False
					})
				return render(request, 'lfi/form_B64.html', {'attack':NameAttack.objects.all(),'form':form})
		else:
			return render(request, 'lfi/form_B64.html', {'attack':NameAttack.objects.all(),'form':FormB64})
	else:
		return render(request, 'lfi/form_B64.html', {'attack':NameAttack.objects.all(),'form':FormB64})

def detail(request, sname, nb):
	at=NameAttack.objects.get(surname=sname)
	det=at.detailedattack_set.get(id=nb)
	return render(request, 'lfi/detail.html',{
		'attack':NameAttack.objects.all(),
		'det':det,
		'at':at
		})

def add_DetailedAttack(request,sname):
	if request.method=="POST":
		form=FormDetailedAttack(request.POST)
		if form.is_valid():
			data=request.POST
			attack=DetailedAttack()
			attack.att=NameAttack.objects.get(surname=sname)
			attack.request=data.get('request')
			attack.parameter=data.get('parameter')
			attack.criticity=data.get('criticity')
			attack.description=data.get('description')
			attack.pub_date=timezone.now()
			attack.save()
			return redirect('lfi:attack',sname=sname)
	else:
		return render(request, 'lfi/add_DetailedAttack.html', {'form':FormDetailedAttack,'at':NameAttack.objects.get(surname=sname)})

def edit_DetailedAttack(request,sname,nb):
	attack=NameAttack.objects.get(surname=sname)
	at=DetailedAttack.objects.get(id=nb)
	if request.method=="POST":
		form=FormDetailedAttack(request.POST)
		if form.is_valid():
			at.request=request.POST.get('request')
			at.parameter=request.POST.get('parameter')
			at.criticity=request.POST.get('criticity')
			at.description=request.POST.get('description')
			at.pub_date=timezone.now()
			at.save()
			return redirect('lfi:attack',sname=sname)
	else:
		form=FormDetailedAttack(initial={
			'request':at.request,
			'parameter':at.parameter,
			'criticity':at.criticity,
			'description':at.description
		})
		return render(request, 'lfi/edit_DetailedAttack.html',{'form':form,'at':attack,'attack':NameAttack.objects.all()})

def delete_DetailedAttack(request,sname,nb):
		attack=NameAttack.objects.get(surname=sname)
		det=attack.detailedattack_set.get(id=nb)
		det.delete()
		return redirect('lfi:attack',sname=sname)

def add_NameAttack(request):
	if request.method=="POST":
		form=FormNameAttack(request.POST)
		if form.is_valid():
			attack=NameAttack()
			attack.name=request.POST.get('name')
			attack.surname=request.POST.get('surname')
			attack.description=request.POST.get('description')
			attack.pub_date=timezone.now()
			attack.save()
			return redirect('lfi:index')
	else:
		return render(request, 'lfi/add_NameAttack.html', {'form':FormNameAttack})

def delete_NameAttack(request,sname):
		attack=NameAttack.objects.get(surname=sname)
		attack.delete()
		return redirect('lfi:index')

def edit_NameAttack(request,sname):
	attack=NameAttack.objects.get(surname=sname)
	if request.method=="POST":
		form=FormNameAttack(request.POST)
		if form.is_valid():
			attack.name=request.POST.get('name')
			attack.surname=request.POST.get('surname')
			attack.description=request.POST.get('description')
			attack.pub_date=timezone.now()
			attack.save()
			return redirect('lfi:index')
	else:
		form=FormNameAttack(initial={
		'name':attack.name,
		'surname':attack.surname,
		'description':attack.description,
		})
		return render(request, 'lfi/edit_NameAttack.html',{'form':form,'a':attack,'attack':NameAttack.objects.all()})

def launch_Attack(request,sname,nb):
	at=NameAttack.objects.get(surname=sname)
	if request.method=="POST":
		form=FormNameAttack(request.POST)
		return redirect('lfi:index')
	else:
		return render(request, 'lfi/launch_Attack.html', {'form':FormLaunchAttack,'at':at,'det':at.detailedattack_set.get(id=nb)})	