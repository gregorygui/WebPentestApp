from django.shortcuts import render
from django.http import HttpResponse
from django.views import generic
from django.utils import timezone
from django.shortcuts import redirect
from .models import NameAttack, DetailedAttack
from .forms import FormDetailedAttack, FormNameAttack, FormLaunchAttack

def index(request):
	return render(request, 'lfi/index.html', {'attack':NameAttack.objects.all()})

def attack(request, sname):
	at=NameAttack.objects.get(surname=sname)
	det=at.detailedattack_set.all()
	return render(request, 'lfi/attack.html', {
		'attack':NameAttack.objects.all(),
		'at':at,
		'det':det
		})

def detail(request, sname, nb):
	at=NameAttack.objects.get(surname=sname)
	det=at.detailedattack_set.get(id=nb)
	return render(request, 'lfi/detail.html',{
		'attack':NameAttack.objects.all(),
		'det':det,
		'at':at
		})

def add_DetailedAttack(request,sname):
	if request.method=="POST":
		form=FormDetailedAttack(request.POST)
		if form.is_valid():
			data=request.POST
			attack=DetailedAttack()
			attack.att=NameAttack.objects.get(surname=sname)
			attack.request=data.get('request')
			attack.parameter=data.get('parameter')
			attack.parameter=data.get('criticity')
			attack.description=data.get('description')
			attack.pub_date=timezone.now()
			attack.save()
			return redirect('lfi:attack',sname=sname)
	else:
		return render(request, 'lfi/add_DetailedAttack.html', {'form':FormDetailedAttack,'at':NameAttack.objects.get(surname=sname)})

def delete_DetailedAttack(request,sname,nb):
		attack=NameAttack.objects.get(surname=sname)
		det=attack.detailedattack_set.get(id=nb)
		det.delete()
		return redirect('lfi:attack',sname=sname)

def add_NameAttack(request):
	if request.method=="POST":
		form=FormNameAttack(request.POST)
		if form.is_valid():
			attack=NameAttack()
			attack.name=request.POST.get('name')
			attack.surname=request.POST.get('surname')
			attack.description=request.POST.get('description')
			attack.pub_date=timezone.now()
			attack.save()
			return redirect('lfi:index')
	else:
		return render(request, 'lfi/add_NameAttack.html', {'form':FormNameAttack})

def delete_NameAttack(request,sname):
		attack=NameAttack.objects.get(surname=sname)
		attack.delete()
		return redirect('lfi:index')

def launch_Attack(request,sname,nb):
	at=NameAttack.objects.get(surname=sname)
	if request.method=="POST":
		form=FormNameAttack(request.POST)
		return redirect('lfi:index')
	else:
		return render(request, 'lfi/launch_Attack.html', {'form':FormLaunchAttack,'at':at,'det':at.detailedattack_set.get(id=nb)})	